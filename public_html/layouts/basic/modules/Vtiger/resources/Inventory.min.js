'use strict';

/* {[The file is published on the basis of YetiForce Public License 5.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */"use strict";function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return "Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}$.Class("Vtiger_Inventory_Js",{inventoryInstance:!1,/**
		 * Get inventory instance
		 * @param {jQuery} container
		 * @returns {Vtiger_Inventory_Js}
		 */getInventoryInstance:function getInventoryInstance(container){if(!1===this.inventoryInstance){var moduleClassName=container.find("[name=\"module\"]").val()+"_Inventory_Js";"undefined"==typeof window[moduleClassName]&&(moduleClassName="Vtiger_Inventory_Js"),"undefined"!=typeof window[moduleClassName]&&(this.inventoryInstance=new window[moduleClassName],this.inventoryInstance.registerEvents(container));}return this.inventoryInstance}},{form:!1,discount:!1,tax:!1,container:!1,inventoryContainer:!1,inventoryHeadContainer:!1,summaryTaxesContainer:!1,summaryDiscountContainer:!1,summaryCurrenciesContainer:!1,rowClass:"tr.inventoryRow",discountModalFields:["aggregationType","globalDiscount","groupCheckbox","groupDiscount","individualDiscount","individualDiscountType","additionalDiscount"],taxModalFields:["aggregationType","globalTax","groupCheckbox","groupTax","individualTax","regionalTax"],/**
		 * Get current form element
		 * @returns {jQuery}
		 */getForm:function getForm(){return this.form},/**
		 * Get current form element
		 * @returns {jQuery}
		 */loadConfig:function loadConfig(){var discontConfig=this.form.find(".js-discount-config"),taxConfig=this.form.find(".js-tax-config");this.discount=discontConfig.length?JSON.parse(discontConfig.val()):{},this.tax=taxConfig.length?JSON.parse(taxConfig.val()):{};},/**
		 * Function that is used to get the line item container
		 * @return : jQuery object
		 */getContainer:function getContainer(){return !1===this.container&&(this.container=$(".js-inv-container")),this.container},getInventoryItemsContainer:function getInventoryItemsContainer(){return this.getContainer().find(".inventoryItems")},getInventoryHeadContainer:function getInventoryHeadContainer(){return !1===this.inventoryHeadContainer&&(this.inventoryHeadContainer=$(".inventoryHeader")),this.inventoryHeadContainer},getInventorySummaryDiscountContainer:function getInventorySummaryDiscountContainer(){return !1===this.summaryDiscountContainer&&(this.summaryDiscountContainer=$(".inventorySummaryDiscounts")),this.summaryDiscountContainer},getInventorySummaryTaxesContainer:function getInventorySummaryTaxesContainer(){return !1===this.summaryTaxesContainer&&(this.summaryTaxesContainer=$(".inventorySummaryTaxes")),this.summaryTaxesContainer},getInventorySummaryCurrenciesContainer:function getInventorySummaryCurrenciesContainer(){return !1===this.summaryCurrenciesContainer&&(this.summaryCurrenciesContainer=$(".inventorySummaryCurrencies")),this.summaryCurrenciesContainer},getNextLineItemRowNumber:function getNextLineItemRowNumber(){var $inventoryItemsNo=$("#inventoryItemsNo"),rowNumber=parseInt($inventoryItemsNo.val())+1;return $inventoryItemsNo.val(rowNumber),rowNumber},getAccountId:function getAccountId(){var accountReferenceField=$("#accountReferenceField").val();return ""==accountReferenceField?"":$("[name=\""+accountReferenceField+"\"]").val()},checkDeleteIcon:function checkDeleteIcon(){1<this.getInventoryItemsContainer().find(this.rowClass).length?this.showLineItemsDeleteIcon():app.getMainParams("isRequiredInventory")&&this.hideLineItemsDeleteIcon();},showLineItemsDeleteIcon:function showLineItemsDeleteIcon(){this.getInventoryItemsContainer().find(".deleteRow").removeClass("d-none");},hideLineItemsDeleteIcon:function hideLineItemsDeleteIcon(){this.getInventoryItemsContainer().find(".deleteRow").addClass("d-none");},getClosestRow:function getClosestRow(element){return element.closest(this.rowClass)},/**
		 * Function which will return the basic row which can be used to add new rows
		 * @return jQuery object which you can use to
		 */getBasicRow:function getBasicRow(){return this.getForm().find(".js-inventory-base-item").eq(0).clone(!0,!0)},isRecordSelected:function isRecordSelected(element){var parentRow=element.closest("tr"),productField=parentRow.find(".recordLabel");return productField.validationEngine("validate")},getTaxModeSelectElement:function getTaxModeSelectElement(row){var items=this.getInventoryHeadContainer();return 0<items.find("thead .js-taxmode").length?$(".js-taxmode"):!!row&&row.find(".js-taxmode")},isIndividualTaxMode:function isIndividualTaxMode(row){var selectedOption=this.getTaxModeSelectElement(row).find("option:selected");return 0===selectedOption.length?1==this.tax.default_mode:1==selectedOption.val()},isGroupTaxMode:function isGroupTaxMode(){var selectedOption=this.getTaxModeSelectElement();return selectedOption&&(selectedOption=selectedOption.find("option:selected"))&&0!==selectedOption.length?0==selectedOption.val():0==this.tax.default_mode},showIndividualTax:function showIndividualTax(){var thisInstance=this,groupTax=thisInstance.getInventoryItemsContainer().find(".js-inv-tax_global"),items=thisInstance.getInventoryItemsContainer().find(".js-inventory-items-body"),newRow=$("#blackIthemTable").find("tbody");if(thisInstance.isIndividualTaxMode()){groupTax.addClass("d-none"),items.find(".changeTax").removeClass("d-none"),newRow.find(".changeTax").removeClass("d-none");var parentRow=thisInstance.getInventoryItemsContainer(),taxParam={aggregationType:"global"};parentRow.find(thisInstance.rowClass).each(function(){var thisItem=$(this);taxParam.globalTax=parseFloat(thisItem.find(".js-tax").attr("data-default-tax")),thisInstance.setTaxParam(thisItem,taxParam);});}else thisInstance.setTax(items,0),thisInstance.setTaxPercent(items,0),thisInstance.setTaxParam(items,[]),thisInstance.setDefaultGlobalTax(),groupTax.removeClass("d-none"),items.find(".changeTax").addClass("d-none"),newRow.find(".changeTax").addClass("d-none");thisInstance.rowsCalculations();},setDefaultGlobalTax:function setDefaultGlobalTax(){var thisInstance=this,parentRow=thisInstance.getInventoryItemsContainer(),taxDefaultValue=thisInstance.getInventorySummaryTaxesContainer().find(".js-default-tax").data("tax-default-value"),isGroupTax=thisInstance.isGroupTaxMode(),summaryContainer=$("#blackIthemTable");if(isGroupTax){var taxParam=thisInstance.getTaxParams(summaryContainer);!1===taxParam&&taxDefaultValue&&(taxParam={aggregationType:"global"},taxParam.globalTax=taxDefaultValue,taxParam.individualTax=""),taxParam&&(thisInstance.setTaxParam(summaryContainer,taxParam),thisInstance.setTaxParam(parentRow,taxParam),parentRow.closest(".inventoryItems").data("taxParam",JSON.stringify(taxParam)),parentRow.find(thisInstance.rowClass).each(function(){thisInstance.quantityChangeActions($(this));}));}else thisInstance.setTaxParam(summaryContainer,[]),parentRow.closest(".inventoryItems").data("taxParam","[]");},/**
		 * Get discount mode
		 * @returns {int}
		 */getDiscountMode:function getDiscountMode(){var selectedOption=this.getContainer().find(".js-discountmode option:selected");return selectedOption.length?selectedOption.val():this.discount.default_mode},getCurrency:function getCurrency(){return $(".js-currency",this.getInventoryHeadContainer()).find("option:selected").val()},/**
		 * Get discount aggregation
		 * @returns {int}
		 */getDiscountAggregation:function getDiscountAggregation(){var element=$(".js-discount_aggreg",this.getInventoryHeadContainer()).find("option:selected");return element.length?parseInt(element.val()):parseInt(this.discount.aggregation)},getTax:function getTax(row){var self=this,taxParams=row.find(".taxParam").val();if(""==taxParams||"[]"==taxParams||null==taxParams)return 0;taxParams=JSON.parse(taxParams);var valuePrices=this.getNetPrice(row),taxRate=0,types=taxParams.aggregationType;return "string"==typeof types&&(types=[types]),types&&types.forEach(function(entry){var taxValue=0;"individual"===entry?taxValue=taxParams.individualTax:"global"===entry?taxValue=taxParams.globalTax:"group"===entry?taxValue=taxParams.groupTax:"regional"===entry?taxValue=taxParams.regionalTax:void 0,taxRate+=valuePrices*(taxValue/100),2==self.tax.aggregation&&(valuePrices+=taxRate);}),taxRate},getTaxPercent:function getTaxPercent(row){var taxParams=row.find(".taxParam").val();if(""==taxParams||"[]"==taxParams||null==taxParams)return 0;taxParams=JSON.parse(taxParams);var taxPercent=0,types="string"==typeof taxParams.aggregationType?[taxParams.aggregationType]:taxParams.aggregationType;return types.forEach(function(aggregationType){taxPercent+=taxParams[aggregationType+"Tax"]||0;}),taxPercent},getTaxParams:function getTaxParams(row){var taxParams=row.find(".taxParam").val();return ""!=taxParams&&"[]"!=taxParams&&null!=taxParams&&JSON.parse(taxParams)},getQuantityValue:function getQuantityValue(row){return $(".qty",row).getNumberFromValue()},getUnitPriceValue:function getUnitPriceValue(row){return $(".unitPrice",row).getNumberFromValue()},getDiscount:function getDiscount(row){var _this=this,discountParams=row.find(".discountParam").val();if(""==discountParams||"null"==discountParams||"[]"==discountParams||null==discountParams)return 0;var aggregation=this.getDiscountAggregation();discountParams=JSON.parse(discountParams);var valuePrices=this.getTotalPrice(row),discountRate=0,types=discountParams.aggregationType;return "string"==typeof types&&(types=[types]),types&&types.forEach(function(entry){"global"===entry?discountRate+=valuePrices*(discountParams.globalDiscount/100):"group"===entry?discountRate+=valuePrices*((discountParams.groupDiscount?discountParams.groupDiscount:0)/100):"individual"===entry?discountRate+="percentage"===discountParams.individualDiscountType?valuePrices*(discountParams.individualDiscount/100):discountParams.individualDiscount:"additional"===entry?discountRate+=valuePrices*(discountParams.additionalDiscount/100):void 0,aggregation==_this.AGGREGATION_CASCADE&&(valuePrices-="markup"===discountParams.type?-discountRate:discountRate);}),discountRate},getNetPrice:function getNetPrice(row){var discount=this.getDiscount(row),discountParams=row.find(".discountParam").val();return discount&&discountParams&&"markup"===JSON.parse(discountParams).type&&(discount=-discount),this.getTotalPrice(row)-discount},getTotalPrice:function getTotalPrice(row){return this.getQuantityValue(row)*this.getUnitPriceValue(row)},getGrossPrice:function getGrossPrice(row){return $(".grossPrice",row).getNumberFromValue()},getPurchase:function getPurchase(row){var qty=this.getQuantityValue(row),element=$(".purchase",row),purchase=0;return 0<element.length&&(purchase=App.Fields.Double.formatToDb(element.val())),purchase*qty},getSummaryGrossPrice:function getSummaryGrossPrice(){var thisInstance=this,price=0;return this.getInventoryItemsContainer().find(thisInstance.rowClass).each(function(){price+=thisInstance.getGrossPrice($(this));}),App.Fields.Double.formatToDb(price)},/**
		 * Set currency
		 * @param {int} val
		 */setCurrency:function setCurrency(val){this.getInventoryHeadContainer().find(".js-currency").val(val).trigger("change");},/**
		 * Set currency param
		 * @param {string} val json string
		 */setCurrencyParam:function setCurrencyParam(val){this.getInventoryHeadContainer().find(".js-currencyparam").val(val);},/**
		 * Set discount mode
		 * @param {int} val
		 */setDiscountMode:function setDiscountMode(val){this.getInventoryHeadContainer().find(".js-discountmode").val(val).trigger("change");},/**
		 * Set tax mode
		 * @param {int} val
		 */setTaxMode:function setTaxMode(val){this.getInventoryHeadContainer().find(".js-taxmode").val(val).trigger("change");},/**
		 * Set inventory id
		 * @param {jQuery} row
		 * @param {int} val
		 * @param {string} display
		 */setName:function setName(row,val,display){row.find(".js-name").val(val).trigger("change"),row.find(".js-name_display").val(display).attr("readonly","true").trigger("change");},/**
		 * Set inventory row quantity
		 * @param {jQuery} row
		 * @param {int} val
		 */setQuantity:function setQuantity(row,val){row.find(".qty").val(val).trigger("change");},/**
		 * Set unit original (db) value
		 * @param {jQuery} row
		 * @param {string} val
		 * @param {string} display
		 */setUnit:function setUnit(row,val,display){row.find(".unit").val(val).trigger("change"),row.find(".unitText").text(display).trigger("change");},/**
		 * Set subUnit original (db) value
		 * @param {jQuery} row
		 * @param {string} val
		 * @param {string} display
		 */setSubUnit:function setSubUnit(row,val,display){row.find(".subunit").val(val),row.find(".subunitText").val(display);},/**
		 * Set inventory row comment
		 * @param {jQuery} row
		 * @param {string} val
		 */setComment:function setComment(row,val){row.parent().find("[numrowex="+row.attr("numrow")+"] .comment").val(val);},/**
		 * Set inventory row unit price
		 * @param {jQuery} row
		 * @param {string} val
		 */setUnitPrice:function setUnitPrice(row,val){return val=App.Fields.Double.formatToDisplay(val),row.find(".unitPrice").val(val).attr("title",val),this},/**
		 * Set inventory row purchase
		 * @param {jQuery} row
		 * @param {string} val
		 */setPurchase:function setPurchase(row,val){return row.find(".purchase").val(App.Fields.Double.formatToDisplay(val)),this},/**
		 * Set inventory row net price
		 * @param {jQuery} row
		 * @param {string} val
		 */setNetPrice:function setNetPrice(row,val){val=App.Fields.Double.formatToDisplay(val),$(".netPriceText",row).text(val),$(".netPrice",row).val(val);},/**
		 * Set inventory row gross price
		 * @param {jQuery} row
		 * @param {string} val
		 */setGrossPrice:function setGrossPrice(row,val){val=App.Fields.Double.formatToDisplay(val),$(".grossPriceText",row).text(val),$(".grossPrice",row).val(val);},/**
		 * Set inventory row total price
		 * @param {jQuery} row
		 * @param {string} val
		 */setTotalPrice:function setTotalPrice(row,val){val=App.Fields.Double.formatToDisplay(val),$(".totalPriceText",row).text(val),$(".totalPrice",row).val(val);},/**
		 * Set inventory row margin
		 * @param {jQuery} row
		 * @param {string} val
		 */setMargin:function setMargin(row,val){$(".margin",row).val(App.Fields.Double.formatToDisplay(val));},/**
		 * Set inventory row margin percent
		 * @param {jQuery} row
		 * @param {string} val
		 */setMarginP:function setMarginP(row,val){$(".marginp",row).val(App.Fields.Double.formatToDisplay(val));},/**
		 * Set inventory row discount
		 * @param {jQuery} row
		 * @param {string} val
		 */setDiscount:function setDiscount(row,val){$(".discount",row).val(App.Fields.Double.formatToDisplay(val));},/**
		 * Set inventory row discount param
		 * @param {jQuery} row
		 * @param {string} val
		 */setDiscountParam:function setDiscountParam(row,val){$(".discountParam",row).val(JSON.stringify(val));},/**
		 * Set inventory row tax
		 * @param {jQuery} row
		 * @param {string} val
		 */setTax:function setTax(row,val){$(".tax",row).val(App.Fields.Double.formatToDisplay(val));},/**
		 * Set inventory row tax percent
		 * @param {jQuery} row
		 * @param {string} val
		 */setTaxPercent:function setTaxPercent(row,val){$(".js-tax-percent",row).val(App.Fields.Double.formatToDisplay(val));},/**
		 * Set inventory row tax param
		 * @param {jQuery} row
		 * @param {string} val
		 */setTaxParam:function setTaxParam(row,val){$(".taxParam",row).val(JSON.stringify(val));},quantityChangeActions:function quantityChangeActions(row){this.rowCalculations(row),this.summaryCalculations();},rowCalculations:function rowCalculations(row){this.calculateTotalPrice(row),this.calculateDiscounts(row),this.calculateNetPrice(row),this.calculateTaxes(row),this.calculateGrossPrice(row),this.calculateMargin(row),app.event.trigger("Inventory.RowCalculations",this,row);},rowsCalculations:function rowsCalculations(){var self=this;this.getInventoryItemsContainer().find(self.rowClass).each(function(){var row=$(this);self.syncHeaderData(row),self.quantityChangeActions(row);}),self.calculateItemNumbers();},calculateDiscounts:function calculateDiscounts(row){this.setDiscount(row,this.getDiscount(row));},calculateTaxes:function calculateTaxes(row){this.setTax(row,this.getTax(row)),this.setTaxPercent(row,this.getTaxPercent(row));},summaryCalculations:function summaryCalculations(){var _this2=this;this.getInventoryItemsContainer().find("tfoot .wisableTd").each(function(_n,e){_this2.calculateSummary($(e));}),this.calculateDiscountSummary(),this.calculateTaxSummary(),this.calculateCurrenciesSummary(),this.calculateMarginPSummary(),this.summaryGroupCalculations();},/**
		 * Get Items
		 * @returns {jQuery} Items
		 */getItems:function getItems(){return this.getInventoryItemsContainer().find(".inventoryRow")},/**
		 * Get groups
		 * @returns {jQuery} Group rows
		 */getGroups:function getGroups(){return this.getInventoryItemsContainer().find(".inventoryRowGroup")},/**
		 * Get group items
		 * @param {jQuery} groupRow
		 * @returns {jQuery} Items
		 */getGroupItems:function getGroupItems(groupRow){return groupRow.nextUntil("tr.inventoryRowGroup").filter("tr.inventoryRow")},/**
		 * Get item group
		 * @param {jQuery} row
		 * @returns {jQuery} group row
		 */getGroupFromItem:function getGroupFromItem(row){for(var classElement="inventoryRowGroup";row.is("tr")&&!row.hasClass(classElement);)row=row.prev();return row.hasClass(classElement)?row:null},summaryGroupCalculations:function summaryGroupCalculations(){var _this3=this;this.getGroups().each(function(_n,e){var groupRow=$(e),items=_this3.getGroupItems(groupRow);groupRow.find(".js-inv-container-group-summary").each(function(_n,e){_this3.calculateSummary($(e),items);}),_this3.calculateMarginPSummary(groupRow);});},calculateSummary:function calculateSummary(element,rows){var thisInstance=this,sum=0,fieldName="string"==typeof element?element:element.data("sumfield");return rows||(rows=this.getInventoryItemsContainer().find(thisInstance.rowClass)),rows.each(function(){var e=$(this).find("."+fieldName);0<e.length&&(sum+=App.Fields.Double.formatToDb(e.val()));}),"object"===_typeof(element)&&(element.get(0).innerText=App.Fields.Double.formatToDisplay(sum)),sum},calculateMarginPSummary:function calculateMarginPSummary(sumRow){sumRow||(sumRow=this.getInventoryItemsContainer().find("tfoot"));var totalPriceField=0<sumRow.find("[data-sumfield=\"netPrice\"]").length?sumRow.find("[data-sumfield=\"netPrice\"]"):sumRow.find("[data-sumfield=\"totalPrice\"]"),sumPrice=totalPriceField.getNumberFromText(),purchase=0,marginp=0,rows=sumRow.hasClass("inventoryRowGroup")?this.getGroupItems(sumRow):this.getInventoryItemsContainer().find(this.rowClass);rows.each(function(){var qty=$(this).find(".qty").getNumberFromValue(),purchasePrice=$(this).find(".purchase").getNumberFromValue();0<qty&&0<purchasePrice&&(purchase+=qty*purchasePrice);});var subtraction=sumPrice-purchase;0!=purchase&&0!==sumPrice&&(marginp=100*subtraction/purchase),sumRow.find("[data-sumfield=\"marginP\"]").text(App.Fields.Double.formatToDisplay(marginp)+"%");},calculateDiscountSummary:function calculateDiscountSummary(){var thisInstance=this,discount=thisInstance.getAllDiscount(),container=thisInstance.getInventorySummaryDiscountContainer();container.find("input").val(App.Fields.Double.formatToDisplay(discount));},getAllDiscount:function getAllDiscount(){var thisInstance=this,discount=0;return this.getInventoryItemsContainer().find(thisInstance.rowClass).each(function(){var row=$(this);discount+=thisInstance.getDiscount(row);}),discount},calculateCurrenciesSummary:function calculateCurrenciesSummary(){var container=this.getInventorySummaryCurrenciesContainer(),selected=$(".js-currency option:selected",this.getInventoryHeadContainer()),base=$(".js-currency option[data-base-currency=\"1\"]",this.getInventoryHeadContainer()),conversionRate=selected.data("conversionRate"),baseConversionRate=base.data("conversionRate");if(conversionRate==baseConversionRate)return void container.addClass("d-none");conversionRate=parseFloat(baseConversionRate)/parseFloat(conversionRate),container.removeClass("d-none");var taxes=this.getAllTaxes(),sum=0;container.find(".js-panel__body").html(""),$.each(taxes,function(index,value){if(value!=null){value*=conversionRate;var row=container.find(".d-none .form-group").clone();row.find(".percent").text(index+"%"),row.find("input").val(App.Fields.Double.formatToDisplay(value)),row.appendTo(container.find(".js-panel__body")),sum+=value;}}),container.find(".js-panel__footer input").val(App.Fields.Double.formatToDisplay(sum));},calculateTaxSummary:function calculateTaxSummary(){var thisInstance=this,taxes=thisInstance.getAllTaxes(),container=thisInstance.getInventorySummaryTaxesContainer();container.find(".js-panel__body").html("");var sum=0;for(var index in taxes){var row=container.find(".d-none .form-group").clone();row.find(".percent").text(App.Fields.Double.formatToDisplay(index)+"%"),row.find("input").val(App.Fields.Double.formatToDisplay(taxes[index])),row.appendTo(container.find(".js-panel__body")),sum+=taxes[index];}container.find(".js-panel__footer input").val(App.Fields.Double.formatToDisplay(sum));},getAllTaxes:function getAllTaxes(){var thisInstance=this,tax=[],typeSummary=$(".aggregationTypeTax").val();return this.getInventoryItemsContainer().find(thisInstance.rowClass).each(function(){var row=$(this),netPrice=thisInstance.getNetPrice(row),params=row.find(".taxParam").val();if(""!=params&&"[]"!=params&&null!=params){var param=JSON.parse(params);"string"==typeof param.aggregationType&&(param.aggregationType=[param.aggregationType]),param.aggregationType&&$.each(param.aggregationType,function(_,name){if(name+="Tax",null!=param[name]){var percent=parseFloat(param[name]),old=0;null!=tax[percent]&&(old=parseFloat(tax[percent]));var taxRate=netPrice*(percent/100);tax[percent]=old+taxRate,"2"==typeSummary&&(netPrice+=taxRate);}});}}),tax},calculateNetPrice:function calculateNetPrice(row){this.setNetPrice(row,this.getNetPrice(row));},calculateGrossPrice:function calculateGrossPrice(row){var netPrice=this.getNetPrice(row);(this.isIndividualTaxMode(row)||this.isGroupTaxMode(row))&&(netPrice+=this.getTax(row)),this.setGrossPrice(row,netPrice);},calculateTotalPrice:function calculateTotalPrice(row){this.setTotalPrice(row,this.getTotalPrice(row));},calculateMargin:function calculateMargin(row){var netPrice=$(".netPrice",row).length?this.getNetPrice(row):this.getTotalPrice(row)-this.getDiscount(row);var purchase=this.getPurchase(row),margin=netPrice-purchase;this.setMargin(row,margin);var marginp="0";0!==purchase&&(marginp=100*(margin/purchase)),this.setMarginP(row,marginp);},AGGREGATION_CANNOT_BE_COMBINED:0,AGGREGATION_IN_TOTAL:1,AGGREGATION_CASCADE:2,calculateDiscount:function calculateDiscount(_row,modal){var globalDiscount,accountDiscount,individualDiscount,additionalDiscount,netPriceBeforeDiscount=App.Fields.Double.formatToDb(modal.find(".valueTotalPrice").text()),aggregationType=modal.find(".aggregationType").val(),isMarkup=1===modal.find(".js-inv--discount-type.markup:checked").length,valuePrices=netPriceBeforeDiscount,getValue=function(type,netPrice,isMarkup){var value=0,element=modal.find(".js-active .".concat(type)),customCheckTrue=!0;return "groupValue"===type&&!0!==modal.find(".js-active .groupCheckbox").prop("checked")&&(customCheckTrue=!1),0<element.length&&customCheckTrue&&(value=App.Fields.Double.formatToDb(element.val())),"individualDiscountValue"===type&&"percentage"==modal.find(".js-active .individualDiscountType:checked").val()&&(value=netPrice*(value/100)),value&&isMarkup?-value:value};aggregationType==this.AGGREGATION_CANNOT_BE_COMBINED||aggregationType==this.AGGREGATION_IN_TOTAL?(globalDiscount=getValue("globalDiscount",netPriceBeforeDiscount,isMarkup),accountDiscount=getValue("groupValue",netPriceBeforeDiscount,isMarkup),individualDiscount=getValue("individualDiscountValue",netPriceBeforeDiscount,isMarkup),additionalDiscount=getValue("additionalDiscountValue",netPriceBeforeDiscount,isMarkup),valuePrices-=netPriceBeforeDiscount*(globalDiscount/100),valuePrices-=netPriceBeforeDiscount*(additionalDiscount/100),valuePrices-=individualDiscount,valuePrices-=netPriceBeforeDiscount*(accountDiscount/100)):aggregationType==this.AGGREGATION_CASCADE&&(globalDiscount=getValue("globalDiscount",valuePrices,isMarkup),valuePrices*=(100-globalDiscount)/100,accountDiscount=getValue("groupValue",valuePrices,isMarkup),valuePrices*=(100-accountDiscount)/100,individualDiscount=getValue("individualDiscountValue",valuePrices,isMarkup),valuePrices-=individualDiscount,additionalDiscount=getValue("additionalDiscountValue",valuePrices,isMarkup),valuePrices*=(100-additionalDiscount)/100);var discountValue=netPriceBeforeDiscount-valuePrices;modal.find(".valuePrices").text(App.Fields.Double.formatToDisplay(valuePrices)),modal.find(".valueDiscount").text(App.Fields.Double.formatToDisplay(isMarkup?-discountValue:discountValue));},calculateTax:function calculateTax(_row,modal){var netPriceWithoutTax=App.Fields.Double.formatToDb(modal.find(".valueNetPrice").text()),valuePrices=netPriceWithoutTax,globalTax=0,groupTax=0,regionalTax=0,individualTax=0,taxType=modal.find(".taxsType").val();if("0"==taxType||"1"==taxType){if(0<modal.find(".js-active .globalTax").length&&(globalTax=App.Fields.Double.formatToDb(modal.find(".js-active .globalTax").val())),0<modal.find(".js-active .individualTaxValue").length){var value=App.Fields.Double.formatToDb(modal.find(".js-active .individualTaxValue").val());individualTax=value/100*valuePrices;}0<modal.find(".js-active .groupTax").length&&(groupTax=App.Fields.Double.formatToDb(modal.find(".groupTax").val()),groupTax=netPriceWithoutTax*(groupTax/100)),0<modal.find(".js-active .regionalTax").length&&(regionalTax=App.Fields.Double.formatToDb(modal.find(".regionalTax").val()),regionalTax=netPriceWithoutTax*(regionalTax/100)),valuePrices*=(100+globalTax)/100,valuePrices+=individualTax,valuePrices+=groupTax,valuePrices+=regionalTax;}else "2"==taxType&&modal.find(".js-active").each(function(){var panel=$(this);0<panel.find(".globalTax").length?valuePrices*=(100+App.Fields.Double.formatToDb(panel.find(".globalTax").val()))/100:0<panel.find(".groupTax").length?valuePrices*=(100+App.Fields.Double.formatToDb(panel.find(".groupTax").val()))/100:0<panel.find(".regionalTax").length?valuePrices*=(100+App.Fields.Double.formatToDb(panel.find(".regionalTax").val()))/100:0<panel.find(".individualTaxValue").length&&(valuePrices=(App.Fields.Double.formatToDb(panel.find(".individualTaxValue").val())+100)/100*valuePrices);});if(netPriceWithoutTax){var taxValue=100*((valuePrices-netPriceWithoutTax)/netPriceWithoutTax);modal.find(".js-tax-value").text(App.Fields.Double.formatToDisplay(taxValue));}modal.find(".valuePrices").text(App.Fields.Double.formatToDisplay(valuePrices)),modal.find(".valueTax").text(App.Fields.Double.formatToDisplay(valuePrices-netPriceWithoutTax));},updateRowSequence:function updateRowSequence(){var items=this.getInventoryItemsContainer();items.find(this.rowClass).each(function(index){$(this).find(".sequence").val(index+1);});},registerInventorySaveData:function registerInventorySaveData(){var _this4=this;app.event.on("EditView.preValidation",function(){_this4.showAllItems();}),this.form.on(Vtiger_Edit_Js.recordPreSave,function(){if(_this4.syncHeaderData(),!_this4.checkLimits(_this4.form))return !1});},syncHeaderData:function syncHeaderData(container){var _this5=this;this.renumberHeaderItems();var header=this.getInventoryHeadContainer();"undefined"==typeof container&&(container=this.getContainer()),container.find(".js-sync").each(function(_,e){var value,element=$(e),name=element.data("syncId"),classElement=".js-"+element.data("syncId");if("grouplabel"===name||"groupid"===name){for(var row=element.closest(_this5.rowClass);row.is("tr")&&1>row.prev().find(classElement).length;)row=row.prev();value=row.prev().find(classElement);}else value=header.find(classElement);element.val(value.length?value.val():element.data("default"));});},/**
		 * Renumber header items
		 */renumberHeaderItems:function renumberHeaderItems(){this.getContainer().find(".js-inv-container-content .js-groupid").each(function(n,e){e.value=n+1;});},/**
		 * Function which will be used to handle price book popup
		 * @params :  element - popup image element
		 */pricebooksModalHandler:function pricebooksModalHandler(element){var _this6=this,lineItemRow=element.closest(this.rowClass),rowName=lineItemRow.find(".rowName"),currencyId=this.getCurrency()||CONFIG.defaultCurrencyId;app.showRecordsList({module:"PriceBooks",src_module:$("[name=\"popupReferenceModule\"]",rowName).val(),src_record:$(".sourceField",rowName).val(),src_field:$("[name=\"popupReferenceModule\"]",rowName).data("field"),search_params:JSON.stringify([[["currency_id","e",currencyId],["active","e",1]]]),lockedFields:["currency_id","active"],cvEnabled:!1,currency_id:currencyId,additionalData:{currency_id:currencyId}},function(_modal,instance){instance.setSelectEvent(function(responseData){AppConnector.request({module:"PriceBooks",action:"ProductListPrice",record:responseData.id,src_record:$(".sourceField",rowName).val()}).done(function(data){data.result?(_this6.setUnitPrice(lineItemRow,data.result),_this6.quantityChangeActions(lineItemRow)):app.errorLog("Incorrect data",responseData);});});});},subProductsCashe:[],loadSubProducts:function loadSubProducts(parentRow,indicator){var progressInstace,thisInstance=this,recordId=$("input.sourceField.js-name",parentRow).val(),recordModule=parentRow.find(".rowName input[name=\"popupReferenceModule\"]").val();if(thisInstance.removeSubProducts(parentRow),"0"==recordId||""==recordId||0>$.inArray(recordModule,["Products","Services"]))return !1;if(thisInstance.subProductsCashe[recordId])return thisInstance.addSubProducts(parentRow,thisInstance.subProductsCashe[recordId]),!1;indicator&&(progressInstace=$.progressIndicator()),AppConnector.request({module:"Products",action:"SubProducts",record:recordId}).done(function(data){var responseData=data.result;thisInstance.subProductsCashe[recordId]=responseData,thisInstance.addSubProducts(parentRow,responseData),progressInstace&&progressInstace.hide();}).fail(function(){progressInstace&&progressInstace.hide();});},removeSubProducts:function removeSubProducts(parentRow){var subProductsContainer=$(".subProductsContainer ul",parentRow);subProductsContainer.find("li").remove();},addSubProducts:function addSubProducts(parentRow,responseData){var subProductsContainer=$(".subProductsContainer ul",parentRow);for(var id in responseData)subProductsContainer.append($("<li>").text(responseData[id]));},mapResultsToFields:function mapResultsToFields(referenceModule,parentRow,responseData){var unit,taxParam=[],thisInstance=this,isGroupTax=thisInstance.isGroupTaxMode();for(var id in responseData){var recordData=responseData[id],description=recordData.description,unitPriceValues=recordData.unitPriceValues,unitPriceValuesJson=JSON.stringify(unitPriceValues);// Load taxes detail
if(isGroupTax){var parameters=parentRow.closest(".inventoryItems").data("taxParam");parameters&&(taxParam=JSON.parse(parameters));}else recordData.taxes&&(taxParam={aggregationType:recordData.taxes.type},taxParam[recordData.taxes.type+"Tax"]=recordData.taxes.value);for(var field in recordData.taxes&&parentRow.find(".js-tax").attr("data-default-tax",recordData.taxes.value),thisInstance.setPurchase(parentRow,recordData.purchase),thisInstance.setTaxParam(parentRow,taxParam),thisInstance.setTax(parentRow,0),thisInstance.setTaxPercent(parentRow,0),recordData.autoFields){var inputField=parentRow.find("input.".concat(field,",select.").concat(field));"checkbox"===inputField.attr("type")?inputField.prop("checked",recordData.autoFields[field]):inputField.is("select")?inputField.val(recordData.autoFields[field]).trigger("change"):inputField.val(recordData.autoFields[field]),recordData.autoFields[field+"Text"]&&parentRow.find("."+field+"Text").text(recordData.autoFields[field+"Text"]);}void 0!==recordData.price&&thisInstance.setUnitPrice(parentRow,recordData.price),void 0!==unitPriceValuesJson&&$("input.unitPrice",parentRow).attr("list-info",unitPriceValuesJson);var commentElement=$("textarea.js-inventory-item-comment",parentRow.next()),editorInstance=CKEDITOR.instances[commentElement.attr("id")];editorInstance?editorInstance.setData(description):commentElement.val(description),"undefined"!=typeof recordData.autoFields.unit&&(unit=recordData.autoFields.unit),app.event.trigger("Inventory.SelectionItem",thisInstance,parentRow,recordData,referenceModule),this.triggerQtyParam(unit,recordData.qtyPerUnit,parentRow);}"Products"===referenceModule&&thisInstance.loadSubProducts(parentRow,!0),thisInstance.quantityChangeActions(parentRow);},/**
		 * Update qtyparam
		 * @param {null|string} unit
		 * @param int perUnit
		 * @param {jQuery} parentRow
		 */triggerQtyParam:function triggerQtyParam(unit,perUnit,parentRow){var validationEngine;switch(unit){default:$(".qtyParamInfo",parentRow).addClass("d-none"),validationEngine="validate[required,funcCall[Vtiger_NumberUserFormat_Validator_Js.invokeValidation]]";break;case"pack":$(".qtyParamInfo",parentRow).removeClass("d-none").removeClass("active"),$(".qtyParamInfo",parentRow).attr("data-content",perUnit),validationEngine="validate[required,funcCall[Vtiger_WholeNumber_Validator_Js.invokeValidation]]";break;case"pcs":$(".qtyParamInfo",parentRow).addClass("d-none"),validationEngine="validate[required,funcCall[Vtiger_WholeNumber_Validator_Js.invokeValidation]]";}$("input.qty",parentRow).attr("data-validation-engine",validationEngine);},saveDiscountsParameters:function saveDiscountsParameters(parentRow,modal){var panels=modal.find("[name=\"aggregationType\"]:checked"),info={};info.aggregationType=[],panels.each(function(){var type=$(this).val(),container=$(this).closest(".js-panel");1<panels.length?info.aggregationType.push(type):info.aggregationType=type,container.find("[name=\""+type+"Discount\"]").each(function(){var param=type+"Discount",element=$(this);switch(type){case"group":element.closest(".input-group").find(".groupCheckbox").prop("checked")&&(info[param]=App.Fields.Double.formatToDb(element.val()));break;case"individual":info["individualDiscountType"]=container.find("[name=\"individualDiscountType\"]:checked").val(),info[param]=App.Fields.Double.formatToDb(element.val());break;case"global":case"additional":info[param]=App.Fields.Double.formatToDb(element.val());}});}),modal.find(".js-inv--discount-type.markup:checked").length&&(info.type="markup");var discoutMode=modal.find(".discountMode").val();discoutMode==this.DISCOUNT_MODE_GROUP?this.setDiscountParam(this.getGroupItems(parentRow),info):discoutMode==this.DISCOUNT_MODE_GLOBAL&&this.setDiscountParam($("#blackIthemTable"),info),this.setDiscountParam(parentRow,info);},saveTaxsParameters:function saveTaxsParameters(parentRow,modal){var info={},extend=["aggregationType","groupCheckbox","individualTaxType"];$.each(this.taxModalFields,function(_,param){0<=$.inArray(param,extend)?1<modal.find("[name=\""+param+"\"]:checked").length?(info[param]=[],modal.find("[name=\""+param+"\"]:checked").each(function(){info[param].push($(this).val());})):info[param]=modal.find("[name=\""+param+"\"]:checked").val():info[param]=App.Fields.Double.formatToDb(modal.find("[name=\""+param+"\"]").val());}),parentRow.data("taxParam",JSON.stringify(info)),this.setTaxParam(parentRow,info),this.setTaxParam($("#blackIthemTable"),info);},showExpandedRow:function showExpandedRow(row){var inventoryRowExpanded=this.getInventoryItemsContainer().find("[numrowex=\""+row.attr("numrow")+"\"]"),element=row.find(".toggleVisibility");element.data("status","1"),element.removeClass(element.data("off")).addClass(element.data("on")),inventoryRowExpanded.removeClass("d-none"),this.markCommentBtn(row);},hideExpandedRow:function hideExpandedRow(row){var inventoryRowExpanded=this.getInventoryItemsContainer().find("[numrowex=\""+row.attr("numrow")+"\"]"),element=row.find(".toggleVisibility");element.data("status","0"),element.removeClass(element.data("on")).addClass(element.data("off")),inventoryRowExpanded.addClass("d-none"),this.markCommentBtn(row);},/**
		 * Mark button for extended fields
		 * @param {jQuery} row
		 */markCommentBtn:function markCommentBtn(row){var rowExpanded=this.getInventoryItemsContainer().find("[numrowex=\""+row.attr("numrow")+"\"]"),value=rowExpanded.find(".js-inventory-item-comment").val(),element=row.find(".js-inv-item-btn-icon"),removeClass=element.data("active"),addClass=element.data("inactive");value&&(removeClass=addClass,addClass=element.data("active")),element.removeClass(removeClass).addClass(addClass);},initTaxParameters:function initTaxParameters(parentRow,modal){var parameters=parentRow.data("taxParam")?parentRow.data("taxParam"):parentRow.find(".taxParam").val();parameters&&(parameters=JSON.parse(parameters.toString()),$.each(this.taxModalFields,function(_,param){var parameter=parameters[param],field=modal.find("[name=\""+param+"\"]");if("checkbox"===field.attr("type")||"radio"===field.attr("type")){var value,array=parameter;$.isArray(array)||(array=[array]),$.each(array,function(_,arrayValue){value=field.filter("[value=\""+arrayValue+"\"]").prop("checked",!0),"aggregationType"===param&&(value.closest(".js-panel").find(".js-panel__body").removeClass("d-none"),value.closest(".js-panel").addClass("js-active"));});}else if("SELECT"===field.prop("tagName"))field.find("option[value=\""+parameter+"\"]").prop("selected","selected").change();else {var input=modal.find("[name=\""+param+"\"]");input.val(App.Fields.Double.formatToDisplay(parameter)),"individualTax"===param&&input.formatNumber();}}),this.calculateTax(parentRow,modal));},limitEnableSave:!1,checkLimits:function checkLimits(){var account=this.getAccountId(),limit=parseInt(app.getMainParams("inventoryLimit")),response=!0;if(""==account||this.limitEnableSave||!limit)return response;var progressInstace=$.progressIndicator();return AppConnector.request({async:!1,dataType:"json",data:{module:app.getModuleName(),action:"Inventory",mode:"checkLimits",record:account,currency:this.getCurrency(),price:thisInthisstance.getSummaryGrossPrice()}}).done(function(data){progressInstace.hide(),!1==data.result.status&&(app.showModalWindow(data.result.html,function(){}),response=!1);}).fail(function(){progressInstace.hide();}),response},currencyChangeActions:function currencyChangeActions(select,option){option.data("baseCurrency")===select.val()?(this.currencyConvertValues(select,option),select.data("oldValue",select.val())):this.showCurrencyChangeModal(select,option);},showCurrencyChangeModal:function showCurrencyChangeModal(select,option){var thisInstance=this;if(!0!=thisInstance.lockCurrencyChange){thisInstance.lockCurrencyChange=!0;var block=select.closest("th"),modal=block.find(".modelContainer").clone();app.showModalWindow(modal,function(data){var modal=$(data),currencyParam=JSON.parse(block.find(".js-currencyparam").val());if(!1!=currencyParam){if("undefined"==typeof currencyParam[option.val()]){currencyParam[option.val()]={value:1,date:""};}modal.find(".currencyName").text(option.text()),modal.find(".currencyRate").val(currencyParam[option.val()].value),modal.find(".currencyDate").text(currencyParam[option.val()].date);}modal.on("click","button[type=\"submit\"]",function(){var rate=modal.find(".currencyRate").val(),value=App.Fields.Double.formatToDb(rate),conversionRate=1/App.Fields.Double.formatToDb(rate);option.data("conversionRate",conversionRate),currencyParam[option.val()]={date:option.data("conversionDate"),value:value.toString(),conversion:conversionRate.toString()},block.find(".js-currencyparam").val(JSON.stringify(currencyParam)),thisInstance.currencyConvertValues(select,option),select.data("oldValue",select.val()),app.hideModalWindow(),thisInstance.lockCurrencyChange=!1;}).one("hidden.bs.modal",function(){select.val(select.data("oldValue")).change(),thisInstance.lockCurrencyChange=!1;});});}},currencyConvertValues:function currencyConvertValues(select,selected){var self=this,previous=select.find("option[value=\""+select.data("oldValue")+"\"]"),conversionRate=selected.data("conversionRate"),prevConversionRate=previous.data("conversionRate");conversionRate=parseFloat(conversionRate)/parseFloat(prevConversionRate),this.getInventoryItemsContainer().find(self.rowClass).each(function(){var row=$(this);self.syncHeaderData(row),self.setUnitPrice(row,self.getUnitPriceValue(row)*conversionRate),self.setDiscount(row,self.getDiscount(row)*conversionRate),self.setTax(row,self.getTax(row)*conversionRate),self.setPurchase(row,self.getPurchase(row)*conversionRate),self.quantityChangeActions(row);});},/**
		 * Set up all row data that comes from request
		 * @param {jQuery} row
		 * @param {object} rowData
		 */setRowData:function setRowData(row,rowData){this.setName(row,rowData.name,rowData.info.name),this.setQuantity(row,App.Fields.Double.formatToDisplay(rowData.qty,App.Fields.Double.FORMAT_TRUNCATE_TRAILING_ZEROS)),this.setUnit(row,rowData.info.autoFields.unit,rowData.info.autoFields.unitText),"undefined"!=typeof rowData.info.autoFields&&"undefined"!=typeof rowData.info.autoFields.subunit&&this.setSubUnit(row,rowData.info.autoFields.subunit,rowData.info.autoFields.subunitText),this.setComment(row,rowData.comment1),this.setUnitPrice(row,rowData.price),this.setNetPrice(row,rowData.net),this.setGrossPrice(row,rowData.gross),this.setTotalPrice(row,rowData.total),this.setDiscountParam(row,rowData.discountparam?JSON.parse(rowData.discountparam):[]),this.setDiscount(row,rowData.discount),this.setTaxParam(row,rowData.taxparam?JSON.parse(rowData.taxparam):[]),this.setTax(row,rowData.tax),this.setTaxPercent(row,rowData.tax_percent);},/**
		 * Add new row to inventory list
		 * @param {string} module
		 * @param {string} baseTableId
		 * @param {object} rowData [optional]
		 */addItem:function addItem(module,baseTableId){var rowData=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2],items=this.getInventoryItemsContainer(),newRow=this.getBasicRow(),sequenceNumber=this.getNextLineItemRowNumber(),replaced=newRow.html().replace(/\_NUM_/g,sequenceNumber),moduleLabels=newRow.data("moduleLbls");return newRow.html(replaced),newRow=newRow.find("tr.inventoryRow, tr.inventoryRowExpanded").appendTo(items.find(".js-inventory-items-body")),newRow.find(".rowName input[name=\"popupReferenceModule\"]").val(module).data("field",baseTableId),newRow.find(".js-module-icon").removeClass().addClass("yfm-".concat(module)),newRow.find(".rowName span.input-group-text").attr("data-content",moduleLabels[module]),newRow.find(".colPicklistField select").each(function(_,select){select=$(select),select.find("option").each(function(_,option){option=$(option),option.data("module")!==module&&option.remove();});}),this.initItem(newRow),Vtiger_Edit_Js.getInstance().registerAutoCompleteFields(newRow),rowData?(this.setRowData(newRow,rowData),this.quantityChangeActions(newRow)):this.itemChangeEvent(newRow),newRow},/**
		 * Item change post event
		 * @param {jQuery} row
		 */itemChangeEvent:function itemChangeEvent(row){var _this7=this;if(row.hasClass("inventoryRowGroup"))this.getItems().each(function(_,e){_this7.itemChangeEvent($(e));});else if(this.getDiscountMode()==this.DISCOUNT_MODE_GROUP){var parentRow=this.getGroupFromItem(row),params=parentRow?parentRow.find(".discountParam").val():null;this.setDiscountParam(row,params?JSON.parse(params):[]),this.rowCalculations(row);}},/**
		 * Add header(group) item
		 * @returns
		 */addHeaderItem:function addHeaderItem(){var data=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},items=this.getInventoryItemsContainer(),newRow=this.getBasicRow();if(data.grouplabel){var value=data.grouplabel,el=newRow.find(".js-grouplabel");if(el.is("select")&&!_toConsumableArray(el.get(0).options).map(function(o){return o.value}).filter(function(e){return ""!==e}).includes(value)){var newOption=new Option(value,value,!0,!0);el.append(newOption);}el.val(value);}return newRow=newRow.find("tr.inventoryRowGroup").appendTo(items.find(".js-inventory-items-body")),this.initItem(newRow),newRow},/**
		 * Get next block ID
		 * @returns int
		 */getNextBlockId:function getNextBlockId(){var data=_toConsumableArray(this.getContainer().find(".js-groupid")).map(function(o){return parseInt(o.value)});return Math.max.apply(Math,_toConsumableArray(data))+1},/**
		 * Register add item button click
		 */registerAddItem:function registerAddItem(){var _this8=this;this.getContainer().find(".js-inv-add-item").on("click",function(e){_this8.addItem(e.currentTarget.dataset.module,e.currentTarget.dataset.field,!1);});},/**
		 * Register add header row
		 */registerAddHeaderItem:function registerAddHeaderItem(){var _this9=this;this.getContainer().find(".js-inv-add-group").on("click",function(){_this9.addHeaderItem();});},registerSortableItems:function registerSortableItems(){var thisInstance=this,items=thisInstance.getContainer();items.sortable({handle:".dragHandle",items:thisInstance.rowClass+",.inventoryRowGroup",revert:!0,tolerance:"pointer",placeholder:"ui-state-highlight",helper:function helper(_e,ui){return ui.children().each(function(_,element){element=$(element),element.width(element.width());}),ui},start:function start(_,ui){items.find(thisInstance.rowClass).each(function(_,element){var row=$(element);thisInstance.hideExpandedRow(row);});var num=$(ui.item).attr("numrow");items.find("[numrowex=\""+num+"\"] .js-inventory-item-comment").each(function(){App.Fields.Text.destroyEditor($(this));}),ui.item.startPos=ui.item.index();},stop:function stop(_,ui){var numrow=$(ui.item).attr("numrow"),child=items.find(".numRow"+numrow);items.find("[numrow=\""+numrow+"\"]").after(child),App.Fields.Text.Editor.register(child),thisInstance.updateRowSequence(),thisInstance.itemChangeEvent(ui.item),thisInstance.summaryGroupCalculations();}});},registerShowHideExpanded:function registerShowHideExpanded(){var _this10=this;this.getInventoryItemsContainer().on("click",".toggleVisibility",function(e){var element=$(e.currentTarget),row=_this10.getClosestRow(element);0==element.data("status")?_this10.showExpandedRow(row):_this10.hideExpandedRow(row);});},/**
		 * Show/Hide group items
		 */registerShowHideExpandedGroup:function registerShowHideExpandedGroup(){var _this11=this;this.getInventoryItemsContainer().on("click",".js-inv-group-collapse-btn",function(e){var btn=$(e.currentTarget),icon=btn.find(".js-toggle-icon"),row=btn.closest("tr.inventoryRowGroup"),items=_this11.getGroupItems(row);icon.hasClass(icon.data("active"))?(items.find(".toggleVisibility.active").closest(".toggleVisibility").trigger("click"),items.addClass("d-none"),btn.removeClass("js-inv-group-collapse-btn__active")):(items.removeClass("d-none"),btn.addClass("js-inv-group-collapse-btn__active"));});},showAllItems:function showAllItems(){this.getGroups().find(".js-inv-group-collapse-btn:not(.js-inv-group-collapse-btn__active)").trigger("click");},registerPriceBookModal:function registerPriceBookModal(container){var _this12=this;container.find(".js-price-book-modal").on("click",function(e){var element=$(e.currentTarget),response=_this12.isRecordSelected(element);response||_this12.pricebooksModalHandler(element);});},registerRowChangeEvent:function registerRowChangeEvent(container){var _this13=this;container.on("focusout",".js-inv-format_number",function(e){$(e.currentTarget).formatNumber(e.currentTarget.dataset.format);}),container.on("focusout",".qty",function(e){var element=$(e.currentTarget);element.formatNumber(App.Fields.Double.FORMAT_TRUNCATE_TRAILING_ZEROS),_this13.quantityChangeActions(_this13.getClosestRow(element));}),container.on("focusout",".unitPrice",function(e){var element=$(e.currentTarget);element.formatNumber(),_this13.quantityChangeActions(_this13.getClosestRow(element));}),container.on("focusout",".purchase",function(e){var element=$(e.currentTarget);element.formatNumber(),_this13.quantityChangeActions(_this13.getClosestRow(element));});var headContainer=this.getInventoryHeadContainer();headContainer.on("change",".js-taxmode",function(){_this13.showIndividualTax();}),headContainer.on("change",".js-discountmode",function(e){var element=$(e.currentTarget),mode=parseInt(element.val());_this13.getContainer().find(".js-change-discount:not([data-mode=\"".concat(mode,"\"])")).addClass("d-none"),_this13.getContainer().find(".js-change-discount[data-mode=\"".concat(mode,"\"]")).removeClass("d-none");var items=_this13.getInventoryItemsContainer().find(".js-inventory-items-body");_this13.setDiscount(items,0),_this13.setDiscountParam(items,[]),_this13.rowsCalculations();});},registerSubProducts:function registerSubProducts(){var thisInstance=this;thisInstance.form.find(".inventoryItems "+thisInstance.rowClass).each(function(){thisInstance.loadSubProducts($(this),!1);});},/**
		 * Register clear reference selection
		 */registerClearReferenceSelection:function registerClearReferenceSelection(){var _this14=this;this.form.on("click",".clearReferenceSelection",function(e){var referenceGroup=$(e.currentTarget).closest("div.referenceGroup");if(referenceGroup.length)referenceGroup.find("input[id$=\"_display\"]").val("").removeAttr("readonly");else {var row=_this14.getClosestRow($(e.currentTarget));_this14.removeSubProducts(row),row.find(".unitPrice,.tax,.discount,.margin,.purchase,.js-tax-percent").val(App.Fields.Double.formatToDisplay(0)),row.find(".qty").val(1),row.find("textarea,.valueVal").val(""),row.find(".valueText").text(""),row.find(".qtyParamInfo").addClass("d-none"),row.find(".recordLabel").val("").removeAttr("readonly"),_this14.isGroupTaxMode()||_this14.setTaxParam(row,[]),_this14.quantityChangeActions(row);}});},registerDeleteLineItemEvent:function registerDeleteLineItemEvent(container){var _this15=this;container.on("click",".deleteRow",function(e){var num=_this15.getClosestRow($(e.currentTarget)).attr("numrow");_this15.deleteLineItem(num);}),container.on("click",".js-delete-header-item",function(e){$(e.currentTarget).closest("tr").remove(),_this15.syncHeaderData(),_this15.rowsCalculations();});},deleteLineItem:function deleteLineItem(num){this.getInventoryItemsContainer().find("[numrowex=\""+num+"\"] .js-inventory-item-comment").each(function(){App.Fields.Text.destroyEditor($(this));}),this.getInventoryItemsContainer().find("[numrow=\""+num+"\"], [numrowex=\""+num+"\"]").remove(),this.checkDeleteIcon(),this.rowsCalculations(),0===this.getInventoryItemsContainer().find(".inventoryRow").length&&$("#inventoryItemsNo").val(0),this.updateRowSequence();},DISCOUNT_MODE_GLOBAL:0,DISCOUNT_MODE_INDIVIDUAL:1,DISCOUNT_MODE_GROUP:2,registerChangeDiscount:function registerChangeDiscount(){var _this16=this;this.form.on("click",".js-change-discount",function(e){var parentRow,element=$(e.currentTarget),params={module:app.getModuleName(),view:"Inventory",mode:"showDiscounts",currency:_this16.getCurrency(),discountAggregation:_this16.getDiscountAggregation(),relatedRecord:_this16.getAccountId(),discountMode:e.currentTarget.dataset.mode};e.currentTarget.dataset.mode==_this16.DISCOUNT_MODE_GLOBAL?(parentRow=_this16.getInventoryItemsContainer(),params.totalPrice=0==parentRow.find("tfoot .colTotalPrice:not(.hideTd)").length?_this16.calculateSummary("totalPrice"):App.Fields.Double.formatToDb(parentRow.find("tfoot .colTotalPrice").text())):e.currentTarget.dataset.mode==_this16.DISCOUNT_MODE_GROUP?(parentRow=element.closest("tr.inventoryRowGroup"),params.totalPrice=_this16.calculateSummary("totalPrice",_this16.getGroupItems(parentRow))):(parentRow=element.closest(_this16.rowClass),params.totalPrice=_this16.getTotalPrice(parentRow)),params.discountParam=parentRow.find(".discountParam").val();var progressInstace=$.progressIndicator();AppConnector.request(params).done(function(data){app.showModalWindow(data,function(data){_this16.registerChangeDiscountModal(data,parentRow,params),_this16.calculateDiscount(parentRow,data);}),progressInstace.hide();}).fail(function(){progressInstace.hide();});});},registerChangeDiscountModal:function registerChangeDiscountModal(modal,parentRow,params){var thisInstance=this,form=modal.find("form");form.validationEngine(app.validationEngineOptions),modal.on("change",".individualDiscountType",function(e){var element=$(e.currentTarget);modal.find(".individualDiscountContainer .input-group-text").text(element.data("symbol"));}),modal.on("change",".activeCheckbox[name=\"aggregationType\"]",function(e){var element=$(e.currentTarget);"checkbox"==element.attr("type")&&this.checked?(element.closest(".js-panel").find(".js-panel__body").removeClass("d-none"),element.closest(".js-panel").addClass("js-active")):"radio"==element.attr("type")?(modal.find(".js-panel").removeClass("js-active"),modal.find(".js-panel .js-panel__body").addClass("d-none"),element.closest(".js-panel").find(".js-panel__body").removeClass("d-none"),element.closest(".js-panel").addClass("js-active")):(element.closest(".js-panel").find(".js-panel__body").addClass("d-none"),element.closest(".js-panel").removeClass("js-active"));}),modal.on("change",".activeCheckbox, .globalDiscount,.individualDiscountValue,.individualDiscountType,.groupCheckbox,.additionalDiscountValue,.js-inv--discount-type",function(){thisInstance.calculateDiscount(parentRow,modal);}),modal.on("click",".js-save-discount",function(){if(!1!==form.validationEngine("validate")){if(thisInstance.saveDiscountsParameters(parentRow,modal),params.discountMode==thisInstance.DISCOUNT_MODE_INDIVIDUAL)thisInstance.setDiscount(parentRow,App.Fields.Double.formatToDb(modal.find(".valueDiscount").text())),thisInstance.quantityChangeActions(parentRow);else if(params.discountMode==thisInstance.DISCOUNT_MODE_GROUP){var rate=App.Fields.Double.formatToDb(modal.find(".valueDiscount").text())/App.Fields.Double.formatToDb(modal.find(".valueTotalPrice").text());thisInstance.getGroupItems(parentRow).each(function(){thisInstance.setDiscount($(this),thisInstance.getTotalPrice($(this))*rate),thisInstance.quantityChangeActions($(this));});}else {var _rate=App.Fields.Double.formatToDb(modal.find(".valueDiscount").text())/App.Fields.Double.formatToDb(modal.find(".valueTotalPrice").text());parentRow.find(thisInstance.rowClass).each(function(){thisInstance.setDiscount($(this),thisInstance.getTotalPrice($(this))*_rate),thisInstance.quantityChangeActions($(this));});}app.hideModalWindow();}});},registerChangeTax:function registerChangeTax(){var thisInstance=this;thisInstance.form.on("click",".changeTax",function(e){var parentRow,element=$(e.currentTarget),params={module:app.getModuleName(),view:"Inventory",mode:"showTaxes",currency:thisInstance.getCurrency(),relatedRecord:thisInstance.getAccountId()};if(element.hasClass("js-inv-tax_global")){parentRow=thisInstance.getInventoryItemsContainer();var totalPrice=0;0<parentRow.find("tfoot .colNetPrice").length?totalPrice=parentRow.find("tfoot .colNetPrice").text():0<parentRow.find("tfoot .colTotalPrice ").length&&(totalPrice=parentRow.find("tfoot .colTotalPrice ").text()),params.totalPrice=App.Fields.Double.formatToDb(totalPrice),params.taxType=1;}else {parentRow=element.closest(thisInstance.rowClass);var sourceRecord=parentRow.find(".rowName .sourceField").val();params.totalPrice=thisInstance.getNetPrice(parentRow),params.taxType=0,sourceRecord&&(params.record=sourceRecord),params.recordModule=parentRow.find(".rowName [name=\"popupReferenceModule\"]").val();}var progressInstace=$.progressIndicator();AppConnector.request(params).done(function(data){app.showModalWindow(data,function(data){thisInstance.initTaxParameters(parentRow,$(data)),thisInstance.registerChangeTaxModal(data,parentRow,params);}),progressInstace.hide();}).fail(function(){progressInstace.hide();});});},lockCurrencyChange:!1,registerChangeCurrency:function registerChangeCurrency(){var _this17=this;this.getInventoryHeadContainer().on("change",".js-currency",function(e){var element=$(e.currentTarget),symbol=element.find("option:selected").data("conversionSymbol");_this17.currencyChangeActions(element,element.find("option:selected")),_this17.form.find(".currencySymbol").text(symbol);});},registerChangeDiscountAggregation:function registerChangeDiscountAggregation(){var _this18=this;this.getInventoryHeadContainer().on("change",".js-discount_aggreg",function(){_this18.rowsCalculations();});},registerChangeTaxModal:function registerChangeTaxModal(modal,parentRow,params){var thisInstance=this,form=modal.find("form");form.validationEngine(app.validationEngineOptions),modal.on("change",".individualTaxType",function(e){var element=$(e.currentTarget);modal.find(".individualTaxContainer .input-group-text").text(element.data("symbol"));}),modal.on("change",".activeCheckbox[name=\"aggregationType\"]",function(e){var element=$(e.currentTarget);"checkbox"==element.attr("type")&&this.checked?(element.closest(".js-panel").find(".js-panel__body").removeClass("d-none"),element.closest(".js-panel").addClass("js-active")):"radio"==element.attr("type")?(modal.find(".js-panel").removeClass("js-active"),modal.find(".js-panel .js-panel__body").addClass("d-none"),element.closest(".js-panel").find(".js-panel__body").removeClass("d-none"),element.closest(".js-panel").addClass("js-active")):(element.closest(".js-panel").find(".js-panel__body").addClass("d-none"),element.closest(".js-panel").removeClass("js-active"));}),modal.on("change",".activeCheckbox, .globalTax, .individualTaxValue, .groupTax, .regionalTax",function(){thisInstance.calculateTax(parentRow,modal);}),modal.on("click",".js-save-taxs",function(){if(!1!==form.validationEngine("validate")){if(thisInstance.saveTaxsParameters(parentRow,modal),"0"==params.taxType)thisInstance.setTax(parentRow,App.Fields.Double.formatToDb(modal.find(".valueTax").text())),thisInstance.setTaxPercent(parentRow,App.Fields.Double.formatToDb(modal.find(".js-tax-value").text())),thisInstance.quantityChangeActions(parentRow);else {var rate=App.Fields.Double.formatToDb(modal.find(".valueTax").text())/App.Fields.Double.formatToDb(modal.find(".valueNetPrice").text());parentRow.find(thisInstance.rowClass).each(function(){var totalPrice;0<$(".netPrice",$(this)).length?totalPrice=thisInstance.getNetPrice($(this)):0<$(".totalPrice",$(this)).length&&(totalPrice=thisInstance.getTotalPrice($(this))),thisInstance.setTax($(this),totalPrice*rate),thisInstance.setTaxPercent($(this),App.Fields.Double.formatToDb(modal.find(".js-tax-value").text())),thisInstance.quantityChangeActions($(this));});}app.hideModalWindow();}});},registerRowAutoComplete:function registerRowAutoComplete(container){var _this19=this,thisInstance=this,sourceFieldElement=container.find(".sourceField.js-name");sourceFieldElement.on(Vtiger_Edit_Js.referenceSelectionEvent,function(e,params){var record=params.record,element=$(e.currentTarget),parentRow=element.closest(thisInstance.rowClass),selectedModule=parentRow.find(".rowName [name=\"popupReferenceModule\"]").val(),formParam={module:app.getModuleName(),action:"Inventory",mode:"getDetails",record:record,fieldname:element.data("columnname")};_this19.getCurrency()&&(formParam.currency_id=_this19.getCurrency(),formParam.currencyParams=_this19.getInventoryHeadContainer().find(".js-currencyparam").val()),AppConnector.request(formParam).done(function(data){for(var id in data)if("object"==_typeof(data[id])){var recordData=data[id];thisInstance.mapResultsToFields(selectedModule,parentRow,recordData);}});});},/**
		 * Mass add entries.
		 */registerMassAddItem:function registerMassAddItem(){var _this20=this;this.getForm().on("click",".js-mass-add",function(e){var currentTarget=$(e.currentTarget),moduleName=currentTarget.data("module"),url=currentTarget.data("url");app.showRecordsList(url,function(_,instance){instance.setSelectEvent(function(data){for(var i in data){var parentElem=_this20.addItem(moduleName,"",!1,currentTarget.closest(".js-inv-container-content"));Vtiger_Edit_Js.getInstance().setReferenceFieldValue(parentElem.find(".rowName"),{name:data[i],id:i});}});});});},calculateItemNumbers:function calculateItemNumbers(){var thisInstance=this,items=this.getInventoryItemsContainer(),i=1;items.find(thisInstance.rowClass).each(function(){$(this).find(".itemNumberText").text(i),i++;});},initItem:function initItem(container){var thisInstance=this;"undefined"==typeof container&&(container=thisInstance.getInventoryItemsContainer()),thisInstance.registerDeleteLineItemEvent(container),thisInstance.registerPriceBookModal(container),thisInstance.registerRowChangeEvent(container),thisInstance.registerRowAutoComplete(container),thisInstance.checkDeleteIcon(),thisInstance.rowsCalculations(),thisInstance.updateRowSequence(),App.Fields.Picklist.showSelect2ElementView(container.find(".selectInv")),App.Fields.Date.register(container,!0,{},"dateFieldInv"),container.validationEngine("detach"),container.validationEngine(app.validationEngineOptions),App.Fields.Text.Editor.register(container);},/**
		 * Load inventory data for specified record
		 * @param {int} recordId
		 * @param {string} sourceModule
		 * @param {function|bool} success callback
		 * @param {function|bool} fail callback
		 * @returns Promise
		 */loadInventoryData:function loadInventoryData(recordId,sourceModule){var _this21=this,success=!!(2<arguments.length&&arguments[2]!==void 0)&&arguments[2],fail=!!(3<arguments.length&&arguments[3]!==void 0)&&arguments[3],progressLoader=$.progressIndicator({blockInfo:{enabled:!0}});return new Promise(function(resolve,reject){AppConnector.request({module:app.getModuleName(),src_module:sourceModule,src_record:recordId,action:"Inventory",mode:"getTableData",record:app.getRecordId()}).done(function(response){var activeModules=[];_this21.getContainer().find(".js-inv-add-item").each(function(_,addBtn){activeModules.push($(addBtn).data("module"));}),progressLoader.progressIndicator({mode:"hide"});var oldCurrencyChangeAction=_this21.currencyChangeActions;_this21.currencyChangeActions=function(select,option){this.currencyConvertValues(select,option),select.data("oldValue",select.val());};var first=response.result[Object.keys(response.result)[0]];_this21.setCurrencyParam(first.currencyparam),_this21.setCurrency(first.currency),_this21.setDiscountMode(first.discountmode),_this21.setTaxMode(first.taxmode),_this21.currencyChangeActions=oldCurrencyChangeAction,_this21.clearInventory(),$.each(response.result,function(_,row){-1===activeModules.indexOf(row.moduleName)?Vtiger_Helper_Js.showMessage({type:"error",textTrusted:!1,text:app.vtranslate("JS_INVENTORY_ITEM_MODULE_NOT_FOUND").replace("${sourceModule}",row.moduleName).replace("${position}",row.info.name)}):(row.groupid&&row.add_header&&_this21.addHeaderItem(row),_this21.addItem(row.moduleName,row.basetableid,row));}),_this21.summaryCalculations(),resolve(response.result),"function"==typeof success&&success(response.result);}).fail(function(error,err){progressLoader.progressIndicator({mode:"hide"}),reject(error,err),"function"==typeof fail&&fail(error,err);});})},/**
		 * Clear inventory data
		 */clearInventory:function clearInventory(){this.getInventoryItemsContainer().find(".deleteRow,.js-delete-header-item").each(function(_,e){$(e).trigger("click");});},/**
		 * Register currency converter
		 */registerCurrencyConverter:function registerCurrencyConverter(){var _this22=this;this.form.on("click",".js-currency-converter-event",function(e){var row=$(e.currentTarget).closest(_this22.rowClass),unitPrice=_this22.getUnitPriceValue(row)||0,currencyId=_this22.getCurrency();App.Components.CurrencyConverter.modalView({currencyId:currencyId,amount:App.Fields.Double.formatToDisplay(unitPrice),currencyParam:_this22.form.find(".js-currencyparam").val()}).done(function(data){var value;currencyId===data.currency_target_id?value=data.currency_target_value:currencyId===data.currency_base_id&&(value=data.currency_base_value),value&&(_this22.setUnitPrice(row,App.Fields.Double.formatToDb(value)),_this22.quantityChangeActions(row));});});},/**
		 * Register head element events
		 */registerHeadEvents:function registerHeadEvents(){var _this23=this;this.getInventoryHeadContainer().find(".js-inv-cuurency_reset").on("click",function(e){app.showConfirmModal({textTrusted:!1,text:e.currentTarget.dataset.confirmation,confirmedCallback:function confirmedCallback(){AppConnector.request(e.currentTarget.dataset.url).done(function(response){response.result&&Object.keys(response.result).length&&(_this23.setCurrencyParam(JSON.stringify(response.result)),_this23.syncHeaderData());});}});});},/**
		 * Function which will register all the events
		 */registerEvents:function registerEvents(container){this.form=container,this.loadConfig(),this.registerInventorySaveData(),this.registerAddItem(),this.registerAddHeaderItem(),this.registerMassAddItem(),this.initItem(),this.registerSortableItems(),this.registerSubProducts(),this.registerChangeDiscount(),this.registerChangeTax(),this.registerClearReferenceSelection(),this.registerShowHideExpanded(),this.registerChangeCurrency(),this.registerChangeDiscountAggregation(),this.setDefaultGlobalTax(container),this.registerShowHideExpandedGroup(),app.registerBlockToggleEvent(container),this.registerCurrencyConverter(),this.registerHeadEvents();}});
//# sourceMappingURL=Inventory.min.js.map
